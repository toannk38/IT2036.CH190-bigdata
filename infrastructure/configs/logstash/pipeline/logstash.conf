input {
  # Beats input (for Filebeat, Metricbeat, etc.)
  beats {
    port => 5044
  }

  # TCP input for application logs
  tcp {
    port => 5000
    codec => json_lines
  }

  # UDP input for syslog
  udp {
    port => 5000
    codec => json_lines
  }

  # Docker logs via GELF
  gelf {
    port => 12201
  }
}

filter {
  # Parse timestamp
  if [@timestamp] {
    date {
      match => [ "@timestamp", "ISO8601" ]
    }
  }

  # Add environment information
  mutate {
    add_field => { "environment" => "${ENVIRONMENT:development}" }
    add_field => { "cluster" => "stock-ai" }
  }

  # Process application logs
  if [fields][service] {
    mutate {
      add_field => { "service_name" => "%{[fields][service]}" }
    }
  }

  # Process JSON logs
  if [message] and [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
    
    if [parsed][level] {
      mutate {
        add_field => { "log_level" => "%{[parsed][level]}" }
      }
    }
    
    if [parsed][service] {
      mutate {
        add_field => { "service_name" => "%{[parsed][service]}" }
      }
    }
    
    if [parsed][correlation_id] {
      mutate {
        add_field => { "correlation_id" => "%{[parsed][correlation_id]}" }
      }
    }
  }

  # Process stock-specific logs
  if [service_name] =~ /stock.*/ {
    mutate {
      add_tag => [ "stock-ai" ]
    }
    
    # Extract stock symbol if present
    if [message] =~ /symbol.*([A-Z]{3,4})/ {
      grok {
        match => { "message" => "symbol.*?(?<stock_symbol>[A-Z]{3,4})" }
      }
    }
  }

  # Process error logs
  if [log_level] =~ /(?i)error|exception|fail/ {
    mutate {
      add_tag => [ "error" ]
    }
  }

  # Process warning logs
  if [log_level] =~ /(?i)warn/ {
    mutate {
      add_tag => [ "warning" ]
    }
  }

  # Clean up temporary fields
  mutate {
    remove_field => [ "parsed" ]
  }
}

output {
  # Main elasticsearch output
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "stock-ai-logs-%{+YYYY.MM.dd}"
    template_name => "stock-ai-logs"
    manage_template => false
  }

  # Error-specific index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "stock-ai-errors-%{+YYYY.MM.dd}"
    }
  }

  # Debug output (remove in production)
  if "${LOG_DEBUG:false}" == "true" {
    stdout {
      codec => rubydebug
    }
  }
}