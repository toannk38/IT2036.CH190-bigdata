version: '3.8'

# Production environment overrides
services:
  mongodb:
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD}
    deploy:
      resources:
        limits:
          memory: ${MONGODB_MEMORY_LIMIT:-2g}
          cpus: '${MONGODB_CPU_LIMIT:-1.5}'
        reservations:
          memory: 1g
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  redis:
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT:-512m}
          cpus: '${REDIS_CPU_LIMIT:-0.5}'
        reservations:
          memory: 256m
          cpus: '0.2'

  kafka:
    environment:
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"  # Disable for production
      KAFKA_DELETE_TOPIC_ENABLE: "false"  # Disable for production
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
    deploy:
      resources:
        limits:
          memory: ${KAFKA_MEMORY_LIMIT:-2g}
          cpus: '${KAFKA_CPU_LIMIT:-1.5}'
        reservations:
          memory: 1g
          cpus: '0.5'

  zookeeper:
    environment:
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_INIT_LIMIT: 5

  nginx:
    volumes:
      - ./configs/nginx/ssl:/etc/nginx/ssl:ro
      - ./docker_volumes/nginx/logs:/var/log/nginx
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: '0.5'
        reservations:
          memory: 128m
          cpus: '0.2'

  prometheus:
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'  # Longer retention for production
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--storage.tsdb.wal-compression'
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 512m
          cpus: '0.3'

  grafana:
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: https://monitoring.yourdomain.com/grafana/
      GF_SECURITY_SECRET_KEY: ${GRAFANA_SECRET_KEY}
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '0.5'
        reservations:
          memory: 256m
          cpus: '0.2'

  elasticsearch:
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: "-Xms${ELASTICSEARCH_HEAP_SIZE:-1g} -Xmx${ELASTICSEARCH_HEAP_SIZE:-1g}"
      xpack.security.enabled: "true"
      ELASTIC_PASSWORD: ${ELASTICSEARCH_PASSWORD}
    deploy:
      resources:
        limits:
          memory: ${ELASTICSEARCH_MEMORY_LIMIT:-2g}
          cpus: '${ELASTICSEARCH_CPU_LIMIT:-1.5}'
        reservations:
          memory: 1g
          cpus: '0.5'

  kibana:
    environment:
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD}
      SERVER_PUBLICBASEURL: https://monitoring.yourdomain.com/kibana/

  logstash:
    environment:
      LS_JAVA_OPTS: "-Xmx1g -Xms1g"
      LOG_DEBUG: "false"
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: '1.0'
        reservations:
          memory: 512m
          cpus: '0.3'

  # Remove development-only services in production
  kafka-ui:
    deploy:
      replicas: 0