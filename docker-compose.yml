version: '3.8'

# Application services: Airflow, Kafka Consumer, API
# These services depend on the infrastructure services (MongoDB, Kafka)
# Start infrastructure first: cd infrastructure && docker-compose up -d

services:
  # Airflow Standalone - Workflow orchestration
  airflow:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    container_name: stock-ai-airflow
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      AIRFLOW_HOME: /opt/airflow
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags
      MONGODB_URI: mongodb://localhost:27017
      MONGODB_DATABASE: vietnam_stock_ai
      KAFKA_BOOTSTRAP_SERVERS: localhost:9092
      KAFKA_PRICE_TOPIC: stock_prices_raw
      KAFKA_NEWS_TOPIC: stock_news_raw
      PYTHONPATH: /opt/airflow
    volumes:
      - ./dags:/opt/airflow/dags
      - ./src:/opt/airflow/src
      - ./data:/opt/airflow/data
      - ./infrastructure/volumes/airflow/logs:/opt/airflow/logs
      - ./infrastructure/volumes/airflow/data:/opt/airflow
    network_mode: host
    command: >
      bash -c "
      echo 'Waiting for infrastructure services...' &&
      sleep 10 &&
      airflow db init &&
      airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com 2>/dev/null || true &&
      echo 'Starting Airflow standalone...' &&
      airflow standalone
      "
    restart: unless-stopped

  # Kafka Consumer - Consumes and stores data from Kafka to MongoDB
  consumer:
    build:
      context: .
      dockerfile: docker/Dockerfile.consumer
    container_name: stock-ai-consumer
    environment:
      MONGODB_URI: mongodb://localhost:27017
      MONGODB_DATABASE: vietnam_stock_ai
      KAFKA_BOOTSTRAP_SERVERS: localhost:9092
      KAFKA_PRICE_TOPIC: stock_prices_raw
      KAFKA_NEWS_TOPIC: stock_news_raw
      LOG_LEVEL: INFO
      PYTHONPATH: /app
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    network_mode: host
    command: >
      bash -c "
      echo 'Waiting for infrastructure services...' &&
      sleep 15 &&
      echo 'Starting Kafka consumer...' &&
      python -m src.consumers.main
      "
    restart: unless-stopped

  # API Service - REST API
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: stock-ai-api
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      MONGODB_URI: mongodb://localhost:27017
      MONGODB_DATABASE: vietnam_stock_ai
      LOG_LEVEL: INFO
      PYTHONPATH: /app
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    network_mode: host
    command: >
      bash -c "
      echo 'Waiting for infrastructure services...' &&
      sleep 10 &&
      echo 'Starting API service...' &&
      uvicorn src.services.api:app --host 0.0.0.0 --port 8000 --reload
      "
    restart: unless-stopped
